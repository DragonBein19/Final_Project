<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Management</title>
    <link rel="stylesheet" href="styles/button.css">
</head>
<body>
<div id="header-bar">TICKET LIVE USERS</div>

<div id="button-container">
    <a href="tickets.html" class="admin-button">Tickets</a>
    <a href="concerts.html" class="admin-button">Concerts</a>
    <a href="users.html" class="admin-button">Users</a>
</div>

<table id="users-table">
    <thead>
    <tr>
        <th>Admin</th>
        <th>Name</th>
        <th>Surname</th>
        <th>Email</th>
        <th>Phone number</th>
        <th>Username</th>
        <th>Registration date</th>
        <th>Edit</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    function deleteUser(button) {
        const row = button.closest("tr");
        const userId = row.getAttribute("data-id");

        if (confirm("Are you sure you want to delete this user?")) {
            fetch(`http://localhost:8080/admin/users/${userId}`, {
                method: "DELETE"
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to delete user from server.");
                    }
                    row.remove();
                })
                .catch(error => {
                    console.error("Error deleting user:", error);
                    alert("Failed to delete user.");
                });
        }
    }

    function editUser(button) {
        const row = button.closest("tr");
        const userId = row.getAttribute("data-id");
        const cells = row.querySelectorAll("td");

        const name = prompt("Edit name:", cells[1].innerText);
        if (name === null) return;

        const surname = prompt("Edit surname:", cells[2].innerText);
        if (surname === null) return;

        const email = prompt("Edit email:", cells[3].innerText);
        if (email === null) return;

        const phone = prompt("Edit phone:", cells[4].innerText);
        if (phone === null) return;

        const userName = prompt("Edit username:", cells[5].innerText);
        if (userName === null) return;

        const updatedUser = {
            isAdmin: cells[0].innerText === "Yes" ? 1 : 0,
            name,
            surname,
            email,
            phone,
            userName
        };

        fetch(`http://localhost:8080/admin/users/${userId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updatedUser)
        })
            .then(response => {
                if (!response.ok) throw new Error("Failed to update user");
                alert("User updated successfully.");
                window.location.reload();
            })
            .catch(error => {
                console.error("Update failed:", error);
                alert("Failed to update user.");
            });
    }

    window.onload = function () {
        fetch("http://localhost:8080/admin/users")
            .then(res => res.json())
            .then(users => {
                const tbody = document.querySelector("#users-table tbody");
                tbody.innerHTML = "";

                users.forEach(user => {
                    const row = document.createElement("tr");

                    const isAdmin = user.isAdmin === true || user.isAdmin === 1;
                    if (isAdmin) row.classList.add("admin-row");

                    row.setAttribute("data-id", user.id);

                    row.innerHTML = `
                        <td>${isAdmin ? 'Yes' : 'No'}</td>
                        <td>${user.name}</td>
                        <td>${user.surname}</td>
                        <td>${user.email}</td>
                        <td>${user.phone}</td>
                        <td>${user.userName}</td>
                        <td>${new Date(user.registrationDate).toLocaleString()}</td>
                        <td>
                            ${isAdmin
                                ? '<span style="color: gray; font-style: italic;">Can not edit</span>'
                                : `
                                    <button class="action-button edit-button" onclick="editUser(this)">Edit</button>
                                    <button class="action-button delete-button" onclick="deleteUser(this)">Delete</button>
                                  `
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(err => console.error("Failed to fetch users:", err));
    };
</script>

<a class="logout-button" href="index.html">Log out</a>
</body>
</html>
